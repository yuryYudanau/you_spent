# Database Implementation Guide

## Overview
?????? ?????????? SQLite ? ???????? ????????? ???? ?????? ? Entity Framework Core ??? ?????? ? ???????. SQLite ????? ??????????? ?? ????????? ?????????? ? ???????????? ??????? ????????????? ? ???????.

## ????????? ???? ??????

### ???????
- **Expenses** - ???????
- **Days** - ???
- **Weeks** - ??????
- **Months** - ??????
- **Years** - ????

### ?????
- Expense ? Day (many-to-one)
- Day ? Week (many-to-one)
- Day ? Month (many-to-one)
- Week ? Month (many-to-one)
- Month ? Year (many-to-one)

## ?????????????

### 1. Dependency Injection
??? ??????????? ? ??????? ????????????? ?????????????? ? DI ?????????? ? `MauiProgram.cs`.

### 2. ??????? ????????????? ? ????

#### ? Page ??? ViewModel ????? Constructor Injection:

```csharp
public partial class MainPage : ContentPage
{
    private readonly ExpenseService _expenseService;

    public MainPage(ExpenseService expenseService)
    {
        InitializeComponent();
        _expenseService = expenseService;
    }

    private async void OnAddExpenseClicked(object sender, EventArgs e)
    {
        var expense = await _expenseService.AddExpenseAsync(
            description: "????",
            amount: 500,
            date: DateTime.Now,
            category: "???"
        );
    }
}
```

#### ?????? ???????? ? ?????????????:

```csharp
public class ExpenseViewModel
{
    private readonly IExpenseRepository _expenseRepository;
    private readonly IDayRepository _dayRepository;

    public ExpenseViewModel(IExpenseRepository expenseRepository, IDayRepository dayRepository)
    {
        _expenseRepository = expenseRepository;
        _dayRepository = dayRepository;
    }

    // CREATE
    public async Task AddExpenseAsync()
    {
        var expense = new Expense
        {
            Description = "???????",
            Amount = 1000,
            Date = DateTime.Now,
            Category = "????????"
        };
        await _expenseRepository.AddAsync(expense);
    }

    // READ
    public async Task<IEnumerable<Expense>> GetAllExpensesAsync()
    {
        return await _expenseRepository.GetAllAsync();
    }

    public async Task<Expense?> GetExpenseByIdAsync(int id)
    {
        return await _expenseRepository.GetByIdAsync(id);
    }

    // UPDATE
    public async Task UpdateExpenseAsync(int id)
    {
        var expense = await _expenseRepository.GetByIdAsync(id);
        if (expense != null)
        {
            expense.Amount = 1500;
            expense.Description = "??????????? ????????";
            await _expenseRepository.UpdateAsync(expense);
        }
    }

    // DELETE
    public async Task DeleteExpenseAsync(int id)
    {
        await _expenseRepository.DeleteAsync(id);
    }

    // ??????????? ???????
    public async Task<IEnumerable<Expense>> GetTodayExpensesAsync()
    {
        return await _expenseRepository.GetExpensesByDayAsync(DateTime.Today);
    }

    public async Task<decimal> GetMonthTotalAsync()
    {
        var startOfMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
        return await _expenseRepository.GetTotalSpentAsync(startOfMonth, endOfMonth);
    }

    public async Task<IEnumerable<string>> GetCategoriesAsync()
    {
        return await _expenseRepository.GetAllCategoriesAsync();
    }
}
```

### 3. ??????????? Page/ViewModel ? DI

???????? ? `MauiProgram.cs`:

```csharp
builder.Services.AddTransient<MainPage>();
builder.Services.AddTransient<ExpenseViewModel>();
```

## CRUD ???????? ??? ???? ?????????

### Expenses (???????)
- `AddAsync` - ???????? ??????
- `GetByIdAsync` - ???????? ?? ID
- `GetAllAsync` - ???????? ???
- `UpdateAsync` - ????????
- `DeleteAsync` - ???????
- `GetExpensesByDateRangeAsync` - ?? ????????? ???
- `GetExpensesByCategoryAsync` - ?? ?????????
- `GetExpensesByDayAsync` - ?? ????
- `GetTotalSpentAsync` - ????? ????????

### Days (???)
- `AddAsync` - ???????? ????
- `GetByIdAsync` - ???????? ?? ID
- `GetAllAsync` - ???????? ???
- `UpdateAsync` - ????????
- `DeleteAsync` - ???????
- `GetDayByDateAsync` - ???????? ???? ?? ????
- `GetDaysByMonthAsync` - ??? ??????
- `GetDaysInRangeAsync` - ??? ? ?????????

### Months (??????)
- `AddAsync` - ???????? ?????
- `GetByIdAsync` - ???????? ?? ID
- `GetAllAsync` - ???????? ???
- `UpdateAsync` - ????????
- `DeleteAsync` - ???????
- `GetMonthAsync` - ???????? ????? (??? + ?????)
- `GetMonthsByYearAsync` - ?????? ????
- `GetMonthWithDetailsAsync` - ? ?????????????

### Years (????)
- `AddAsync` - ???????? ???
- `GetByIdAsync` - ???????? ?? ID
- `GetAllAsync` - ???????? ???
- `UpdateAsync` - ????????
- `DeleteAsync` - ???????
- `GetYearAsync` - ???????? ??? ?? ??????
- `GetYearWithDetailsAsync` - ? ?????????????

## ???????????? ???? ??????

???? ?????? ????????? ????????????? ??? ?????? ??????? ?????????? ?:
- **Android**: `/data/data/com.companyname.youspent/files/youspent.db3`
- **iOS**: `~/Library/youspent.db3`
- **Windows**: `%LOCALAPPDATA%\Packages\...\LocalState\youspent.db3`

## ?????????? ? ???????? ?????????????

??? ??????? ????????????? ? ??????? ?????????????:

1. ???????? ???? ????????????? ? ??????:
```csharp
public DateTime? LastSyncDate { get; set; }
public string? CloudId { get; set; }
public bool IsSynced { get; set; }
```

2. ???????????? Azure Mobile Apps, Firebase ??? ??????????? API

3. ??????????? conflict resolution ??? ?????????????

## ???????? (??? production)

??? ????????????? ???????? ?????? `EnsureCreatedAsync`:

1. ?????????? .NET SDK
2. ????????? ???????:
```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

3. ???????? ? `DatabaseService.cs`:
```csharp
await _context.Database.MigrateAsync();
```

## ??????? ??????

??? ??????? ???? ??????:
```csharp
var databaseService = serviceProvider.GetRequiredService<DatabaseService>();
await databaseService.ClearAllDataAsync();
```
